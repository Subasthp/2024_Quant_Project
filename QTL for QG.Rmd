---
title: "VRS-F2"
author: "Gabrielle Thooft"
date: "2024-05-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Setup: packages, phenotype and linkage map(genotype) files, where to drop results
```{r}
#install.packages("MetaPipe")
#install.packages("remotes")
#remotes::install_github("villegar/MetaPipe",build_vingettes=TRUE)
library("MetaPipe")
#install.packages("bestNormalize")
library("bestNormalize")
#file.choose()
#***phenotype file location, used in scans, transformations, & normality checks***
raw <- read.csv("C:\\Users\\Gabby\\Desktop\\QTL for QG\\VRS23.csv")
head(raw)

#***genotype/ linkage map file location, used in scans***
Genmap <- read.csv("\\Users\\Gabby\\Desktop\\QTL for QG\\VRS-F2 map.csv")
head(Genmap)

#***where to drop scans, change location*** 
folder <- "\\Users\\Gabby\\Desktop\\QTL for QG\\folder"
#***Tell R how to label csv files for scans, change the location. ***
sscan <- "\\Users\\Gabby\\Desktop\\QTL for QG\\folder\\skew_scan.csv"
nscan <- "\\Users\\Gabby\\Desktop\\QTL for QG\\folder\\norm_scan.csv"
swithperm <- "\\Users\\Gabby\\Desktop\\QTL for QG\\folder\\skew_perm.csv"
nwithperm <- "\\Users\\Gabby\\Desktop\\QTL for QG\\folder\\norm_perm.csv"

#indexing numbers for automation of normality check section
auto <- ncol(raw)
#take out label column
adjusted <- auto - 1
```
output: linkage map dataframe and phenotype dataframe


```{r}
#*** assure all traits are integers or number and ID are characters ***
data <- raw
str(data)
```
pull normal traits from raw data by Applying Shapiro-Wilk test to numeric columns
```{r}
#***original data***
Wtest1 <- raw
#***Identify numeric columns from the specified range***
num <- which(sapply(Wtest1[, 2:auto], is.numeric))
num <- 1:adjusted[num]
#**numbers should now be 1:#of actual traits**
#***Apply Shapiro-Wilk test to each numeric column and handle possible errors***
status1 <- do.call(
  rbind,
  lapply(Wtest1[, num + 1], function(x) {  # '+1' adjusts for column index in the full dataframe
    tryCatch({
      test_result <- shapiro.test(x)
      data.frame(statistic = test_result$statistic, p.value = test_result$p.value)
    }, error = function(e) {
      data.frame(statistic = NA, p.value = NA)  # Return NA if the test fails
    })
  })
)
#***Add a column indicating whether the distribution is "Normal" or "Skew" based on the p-value**
status1$Distribution <- ifelse(status1$p.value >= 0.05, "Normal", "Skew")
#**Print the results**
print(status1)
```
output: dataframe indicating W value, significance,and normality 

loops for separating skewed from normal for ease of recall
```{r}
#***add a column to the status data frame to identify the traits***
status1$trait<- seq(2, auto)
                  #2,number of variables in raw
#***make lists to hold loop results***
skewed_traits1 <- c()
normal_traits1 <- c()

#***find the skewed traits*** 
for (i in 1:nrow(status1)) {
    if (status1$Distribution[i] == "Skew") {
        skewed_traits1 <- c(skewed_traits1, status1$trait[i])
    }
}
#***find the normal traits***
for (i in 1:nrow(status1)) {
    if (status1$Distribution[i] == "Normal") {
        normal_traits1 <- c(normal_traits1, status1$trait[i])
    }
}
#***print vectors for visual affirmation***
print(skewed_traits1)
print(normal_traits1)

#***create dataframes with the traits we pulled from status and separated**
norm1 <- Wtest1[c(1,normal_traits1)]
skew1 <- Wtest1[c(1,skewed_traits1)]
```
output: two vectors, first is normal second is of the skewed traits
 
 Transformation
```{r}
#***storage**
normalized_results <- list()
#***Initialize a new dataframe to store the normalized values*
normalized_data <- data.frame(ID = raw$ID)  
#**Loop through traits*
for (col in names(skew1)) {
  #**Check if the column is numeric*
  if (is.numeric(skew1[[col]])) {
    #**Apply bestNormalize and store the result*
    normalized <- bestNormalize(skew1[[col]], na.rm = TRUE)
    #**Save the result in a list with the column name as the key*
    normalized_results[[col]] <- normalized
    
    #**Add the transformed values to the new dataframe with a prefix*
    normalized_data[[(col)]] <- predict(normalized)}}

#**View the new dataframe with normalized values*
head(normalized_data)
```
output: the new dataframe including the transformed traits


Explore chosen transformations
```{r}
#**Check the transformation applied to the columns*
for (col in names(normalized_results)) {
  cat("Transformation for", col, ":\n")
  print(normalized_results[[col]]$chosen_transform)
  cat("\n")  
}
```
output:information on each trait including which transformation used(center_scale(x)), how many individuals are a part of the transformation, and the estimated statistics. 

Applying Shapiro-Wilk test to transformed data
```{r}
#**call the transformed data*
Wtest <- normalized_data
#**indexing numbers for automation of SKEW vs NORMAL code*
auto2 <- ncol(Wtest)
#**take out label column*
adjusted2 <- auto2 - 1
#**Identify numeric columns from the specified range*
num <- which(sapply(Wtest[, 2:auto2], is.numeric))
num <- 1:adjusted2[num]
##**numbers should now be 1:#of actual traits*
#**Apply Shapiro-Wilk test to each numeric column and handle possible errors*
status <- do.call(
  rbind,
  lapply(Wtest[, num + 1], function(x) {  # '+1' adjusts for ID column in the full dataframe
    tryCatch({
      test_result <- shapiro.test(x)
      data.frame(statistic = test_result$statistic, p.value = test_result$p.value)
    }, error = function(e) {
      data.frame(statistic = NA, p.value = NA)  # Return NA if the test fails
    })
  })
)

#**Add a column indicating whether the distribution is "Normal" or "Skew" based on the p-value*
status$Distribution <- ifelse(status$p.value >= 0.05, "Normal", "Skew")

#**Print the results*
print(status)
```
output:dataframe showing the same format as the first Shapiro-Wilk test to test if the transformation worked. 

loops for separating skewed from normal for ease of recall
```{r}
#**add a column to the status data frame to identify the traits *
status$trait<- seq(2, auto2)
#2:number of variables in raw

#**make lists to hold loop results*
skewed_traits <- c()
normal_traits <- c()

#**find the skewed traits*
for (i in 1:nrow(status)) {
    if (status$Distribution[i] == "Skew") {
        skewed_traits <- c(skewed_traits, status$trait[i])
    }
}
#**find the normal traits*
for (i in 1:nrow(status)) {
    if (status$Distribution[i] == "Normal") {
        normal_traits <- c(normal_traits, status$trait[i])
    }
}
#**print vectors for visual affirmation *
print(skewed_traits)
print(normal_traits)

```
output: two vectors (in this cause the skewed traits were not able to be transformed to be normal). 

compliation of traits for QTL analysis
```{r}
#**create dataframes with the traits we pulled from status and separated *
norm2 <- Wtest[c(1,normal_traits)]
skew2 <- Wtest[c(1,skewed_traits)]

#**norm1 and skew1 are the dataframes from the first Shapiro Wilk test*
norm <- cbind(norm1,norm2)
skew <- cbind(skew1,skew2)
#**deleting the extra ID columns from normalizing process*
id_columns1 <- which(names(norm) == "ID")
if(length(id_columns1) > 1) {
    norm <- norm[, -id_columns1[-1]]
}
#**same but for the skewed*
id_columns <- which(names(skew) == "ID")
if(length(id_columns) > 1) {
    skew <- skew[, -id_columns[-1]]
}

print(norm)
print(skew)
```
output: two dataframes, normal and skewed

### Normal traits 
```{r}
#**Loads cross file with genetic map and raw data for normal traits, takes the map we loaded in at the beginning*
x <- MetaPipe::read.cross(Genmap, 
                      norm,
                          genotypes = c("A", "H", "B"))
```
output: counts individuals, markers, and phenotypes loaded in. 292, 2519,8 and should show F2 as the cross type



```{r}
#**uses a set seed for regression randomization to aid in replication*
set.seed(123)
x <- qtl::jittermap(x)
x <- qtl::calc.genoprob(x, step = 1, error.prob = 0.001)
x_scone <- MetaPipe::qtl_scone(x, 1, model = "normal", method = "hk")
x_scone
#**where are you putting the scan?*
write.csv(x_scone,nscan)
#**holds the regular scan*
```
output: header for the scan created, deposits information into the normal scan csv


```{r}
x_perm <- MetaPipe::qtl_perm_test(
  x,
  cpus = 1,
  qtl_method = "par-scanone",
  raw_data_normalised = NULL,
  lod_threshold = 3,
  parametric = T,
  n_perm = 1000,
    #where to drop plots 
  plots_dir = folder,
 model = "normal", method = "hk")
write.csv(x_perm,nwithperm)
#holds the norm perm scan \
```
output: deposits in the normal permutations csv
### Skewed traits
```{r}
# Load cross file with genetic map and raw data for normal traits
s <- MetaPipe::read.cross(Genmap, 
                      skew,
                        genotypes = c("A","H","B"))
```
output: similar output to normal map 292, 2519,2 and should show F2 as the cross type

```{r}
set.seed(123)
s <- qtl::jittermap(s)
s <- qtl::calc.genoprob(s, step = 1, error.prob = 0.001)
s_scone <- MetaPipe::qtl_scone(s, 1, model = "np", method = "hk")
s_scone
write.csv(s_scone,sscan)
#where to drop the regular scan and what to name
```


```{r}
s_perm <- MetaPipe::qtl_perm_test(
  s,
  cpus = 1,
  qtl_method = "par-scanone",
  raw_data_normalised = NULL,
  lod_threshold = 3,
  parametric = F,
  n_perm = 1000,
  #where to drop plots 
  plots_dir = folder,
   model = "np", method = "hk")
write.csv(s_perm,swithperm)
#where to drop the skewed perm file and what to name
```
output: deposits scan into skew permutations csv